name: Build and Run C# Application on Excel File Push

on:
  push: # Trigger the workflow on push events
    branches:
      - main # Adjust this based on your branch
    paths:
      - '**.xlsx' # Detect any Excel file changes in the repository

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    env: 
      wrkng-dir: GRL-Zoho-Insights

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Checkout GRL-Zoho-Insights
      uses: actions/checkout@v3
      with:
          ref: TaskCreate
          repository: chandrashekhar54/GRL-Zoho-Insights
          path: ${{env.wrkng-dir}}
          token: ${{ secrets.GH_PAT }}

    - name: Set up .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '7.0.x' # Adjust the version based on your project

    - name: Restore NuGet packages
      run: dotnet restore GRL-Zoho-Insights/GRL-Zoho-Insights.csproj
      working-directory: ${{env.wrkng-dir}}

    - name: Detect Changed Excel File
      id: detect_excel_file
      run: |
        echo "Checking for changed .xlsx files..."
        CHANGED_FILE=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.xlsx$' | head -n 1)
        echo "Changed file: $CHANGED_FILE"
        echo "::set-output name=excel_file::$CHANGED_FILE"
        ##GET PATH OF XL FILE+
      
    - name: Fail if no Excel file was changed
      if: steps.detect_excel_file.outputs.excel_file == ''
      run: |
        echo "Error: No Excel file detected in the recent push."
        exit 1

    - name: Build Zoho Automation Tool
      run: dotnet build GRL-Zoho-Insights/GRL-Zoho-Insights.csproj --configuration Release <XL PATH>
      working-directory: ${{env.wrkng-dir}}

    - name: Run Zoho Automation Tool
      run: dotnet run --project GRL-Zoho-Insights/GRL-Zoho-Insights.csproj <XL PATH>
      working-directory: ${{env.wrkng-dir}}
